<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="./output.css" />
    <title>JSON output organize</title>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.2/dist/cdn.min.js"></script>
  </head>
  <body class="w-screen h-full flex flex-col items-center">
    <h1 class="text-5xl">툴아웃풋</h1>
    <main
      class="w-full h-full flex flex-col items-center justify-center"
      x-data="handleInput">
      <textarea
        class="textarea w-1/2 h-1/2 focus:outline-none"
        placeholder="Paste JSON here!&#10;It's not going anywhere - Handled locally."
        x-model="inputText"
        @input="jsonInputHandler()"></textarea>
      <template x-for="item in tree">
        <div x-show="item.isImportant">
          <span x-text="item.key" :class="`pl-{item.depth*20}px`"></span>
          <button
            class="btn btn-link"
            x-data="{appearance:['△', '▽'], appIdx:0}"
            x-init="appIdx = item.isOpen ? 1:0"
            x-show="item.hasChild"
            @click="item.isOpen = !item.isOpen, appIdx = Math.abs(appIdx - 1)"
            x-text="appearance[appIdx]"></button>
          <span x-show="!item.hasChild||item.isOpen" x-text="item.value"></span>
          <!-- <template x-show="item.hasChild&&item.isOpen">not yet implemented</template> -->
        </div>
      </template>
      <!-- <div x-text="JSON.stringify(tree)"></div> -->
    </main>
    <script>
      document.addEventListener("alpine:init", () => {
        Alpine.data("handleInput", () => ({
          inputText: "",
          tree: [],
          jsonInputHandler() {
            try {
              const parsed = JSON.parse(this.inputText);
              this.tree = [];
              this.buildTree(this.tree, parsed, 0);
              console.log(this.tree);
            } catch (e) {
              this.tree = [];
            }
          },
          buildTree(tree, obj, depth) {
            const importantKeys = [
              "asin",
              "product_title",
              "product_price",
              "product_original_price",
              "product_star_rating",
              "product_num_ratings",
              "product_url",
              "about_product",
              "customers_say",
              "delivery",
              "deal_badge",
            ];
            if (typeof obj === "object" && obj !== null) {
              Object.entries(obj).forEach(([K, V]) => {
                const isImportant = importantKeys.includes(K);
                const isObject = typeof V === "object" && V !== null;
                const child = {
                  key: K,
                  value: isObject ? "" : V,
                  depth: depth,
                  hasChild: isObject,
                  isImportant: isImportant ? true : false,
                  isOpen: isImportant ? true : false,
                };
                tree.push(child);
                if (isObject) this.buildTree(tree, V, depth + 1);
              });
            }
          },
        }));
      });
    </script>
    <footer></footer>
  </body>
</html>
