<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="./output.css" />
    <title>JSON output organize</title>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.2/dist/cdn.min.js"></script>
  </head>
  <body class="w-screen h-full flex flex-col items-center overflow-x-hidden">
    <h1 class="text-5xl">툴아웃풋</h1>
    <main
      class="w-full h-full flex flex-col items-center justify-center"
      x-data="handleInput">
      <textarea
        class="textarea w-2/3 h-1/8 focus:outline-none"
        placeholder="Paste JSON here!&#10;It's not going anywhere - Handled locally."
        x-model="inputText"
        @input="jsonInputHandler()"></textarea>
      <div class="w-2/3 flex-1 overflow-y-auto">
        <template x-for="item in tree">
          <details
            x-show="item.isImportant"
            class="my-1 py-0.5 collapse bg-base-100 border"
            :open="item.isOpen||!item.hasChild">
            <summary
              class="py-2 collapse-title bg-primary-content font-semibold"
              x-text="item.key"></summary>
            <div
              class="collapse-content text-sm"
              x-show="!item.hasChild"
              x-text="item.value"></div>
            <template x-if="item.hasChild">
              <template x-for="child in item.value">
                <details
                  class="my-1 ml-3 collapse bg-base-200 border-base-300 border"
                  open>
                  <summary
                    class="collapse-title bg-secondary-content font-semibold"
                    x-text="child.key"></summary>
                  <div
                    class="collapse-content text-sm"
                    x-show="!child.hasChild"
                    x-text="child.value"></div>
                </details>
              </template>
            </template>
          </details>
        </template>
      </div>
    </main>
    <script>
      const importantKeys = new Set([
        "asin",
        "product_title",
        "product_price",
        "product_original_price",
        "product_star_rating",
        "product_num_ratings",
        "product_url",
        "about_product",
        "customers_say",
        "delivery",
        "deal_badge",
        "title",
        "snippet",
        "subnews",
        "newsUrl",
        "publisher",
      ]);
      document.addEventListener("alpine:init", () => {
        Alpine.data("handleInput", () => ({
          inputText: "",
          tree: null,
          jsonInputHandler() {
            try {
              const parsed = JSON.parse(this.inputText);
              this.tree = this.buildTree(parsed);
              console.log(this.tree);
            } catch (e) {
              this.tree = null;
            }
          },
          buildTree(obj) {
            if (typeof obj === "object" && obj !== null)
              return Object.entries(obj).map(([K, V]) => {
                const isObject = typeof V === "object" && V !== null;
                const isImportant = importantKeys.has(K);
                const isInArray = Array.isArray(obj);
                return {
                  key: K,
                  value: this.buildTree(V),
                  hasChild: isObject,
                  isImportant: isInArray ? true : isImportant,
                  isOpen: isInArray || (isImportant && isObject),
                };
              });
            else return obj;
          },
        }));
      });
    </script>
    <footer></footer>
  </body>
</html>
