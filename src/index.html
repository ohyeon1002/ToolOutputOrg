<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="./output.css" />
    <link rel="icon" href="./brackets.svg" />
    <title>JSON output organize</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script> -->
    <style>
      .v-enter-active,
      .v-leave-active {
        transition: opacity 0.5s ease;
      }

      .v-enter-from,
      .v-leave-to {
        opacity: 0;
      }
    </style>
  </head>
  <body class="w-screen h-full flex flex-col items-center overflow-x-hidden">
    <main
      class="w-full h-full flex flex-col items-center justify-center"
      id="app">
      <h1 class="my-2 text-5xl" v-if="!inputText">ğŸ”See JSON BetterğŸ“œ</h1>
      <ul v-if="selectedSubjects">
        <li class="text-3xl" v-for="sbj in selectedSubjects">{{sbj}}</li>
      </ul>

      <!-- toast messages -->
      <transition>
        <div class="mt-25 toast toast-top toast-center" v-show="wrongFormat">
          <div class="alert alert-soft alert-error text-lg font-bold">
            Invalid Format
          </div>
        </div>
      </transition>
      <transition>
        <div class="mt-25 toast toast-top toast-center" v-show="notYetPasted">
          <div class="alert alert-soft alert-error text-lg font-bold">
            Paste a JSON
          </div>
        </div>
      </transition>
      <transition>
        <div class="toast toast-middle toast-center" v-show="isJustCopied">
          <div class="alert alert-soft alert-success text-lg font-bold">
            âœ…Copied!
          </div>
        </div>
      </transition>
      <!-- /toast messages -->

      <!-- pipcounter -->
      <teleport :to="pipTarget" v-if="isPipOpen && pipTarget">
        <!-- ìŠ¤íƒ€ì¼ ë¡œì§ ì œì™¸, ê¸°ëŠ¥ë§Œ ìœ ì§€ -->
        <div>
          <h2>Counter</h2>
          <h1>{{ pipCount }}</h1>
          <div>
            <button @click="pipCount++">â• UP</button>
            <button @click="pipCount = 0">ğŸ”„ RESET</button>
          </div>
        </div>
      </teleport>
      <!-- /pipcounter -->

      <!-- buttons -->
      <div class="my-2 w-2/3 flex flex-row justify-between">
        <button class="btn btn-soft btn-xl" @click="textAreaEraser">
          ğŸ—‘ï¸WIPE
        </button>
        <button class="btn btn-soft btn-xl btn-info" @click="openPipCounter">
          â±ï¸Counter
        </button>
        <button class="btn btn-soft btn-xl btn-accent" @click="randomSubjects">
          â“Random
        </button>
        <button
          class="btn btn-soft btn-xl btn-primary"
          @click="openSettingsModal">
          âš™ï¸Setting
        </button>
        <button class="btn btn-soft btn-xl btn-secondary" @click="refresh">
          âŒRESET
        </button>
      </div>
      <!-- /buttons -->

      <!-- modal -->
      <dialog class="modal" ref="settingModal">
        <div class="modal-box w-11/12 max-w-5xl flex flex-col h-[80vh]">
          <form method="dialog">
            <button
              class="btn btn-sm btn-circle btn-soft btn-accent absolute right-2 top-2"
              @click="applyImportantKeys">
              <img class="size-10" src="./close-x.svg" />
            </button>
          </form>
          <h3 class="text-lg font-bold">Choose elements to keep</h3>
          <div class="flex-1 overflow-y-auto grid grid-cols-3 gap-2">
            <template v-for="[depth, keySet] in allKeys" :key="depth">
              <div class="divider col-span-full">Depth {{depth}}</div>
              <button
                class="btn btn-soft btn-neutral"
                v-for="key in keySet"
                :class="{'btn-active':isImportant(key)}"
                @click="toggleKey(key)">
                {{key}}
              </button>
            </template>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop">
          <button class="hover:cursor-default" @click="applyImportantKeys">
            Closer
          </button>
        </form>
      </dialog>
      <!-- /modal -->
      <!-- text input -->
      <textarea
        class="textarea w-2/3 h-1/8 focus:outline-none"
        placeholder="Paste JSON here!&#10;It's not going anywhere - Handled locally."
        v-if="!inputText"
        v-model="inputText"
        @input="jsonInputHandler"></textarea>
      <textarea
        class="textarea mt-5 w-2/3 focus:outline-none overflow-y-hidden"
        placeholder='"param1": "value1",&#10;"param2": number2,&#10;"param3": "value3"  becomes â€¦ `param1` "value1", `param2` "number2", and `param3` "value3".'
        v-if="!inputText&&!inputParams"
        v-model="inputParams"
        @input="paramsInputHandler"></textarea>
      <!-- /text input -->
      <!-- params comment -->
      <div class="join w-2/3 mt-5" v-if="paramsComment">
        <input
          type="text"
          class="join-item input input-xl input-success w-full text-2xl"
          v-model="paramsComment"
          readonly />
        <button
          class="join-item btn btn-xl btn-success"
          @click="copyParamsComment">
          ğŸ“‹COPY
        </button>
      </div>
      <!-- /params comment -->
      <!-- visualized json -->
      <div
        class="w-2/3 flex-1 overflow-y-auto grid grid-cols-4 gap-x-5 auto-rows-max">
        <recur
          v-for="node in parsedTree"
          :node="node"
          :bg-color="bgColor"
          :is-important-keys-empty="isImportantKeysEmpty"></recur>
      </div>
      <!-- /visualized json -->
    </main>
    <!-- Vue script -->
    <script>
      const { createApp } = Vue;
      const app = createApp({
        data() {
          return {
            inputText: "",
            parsedTree: null,
            wrongFormat: false,
            notYetPasted: false,
            bgColor: [
              "bg-primary/50",
              "bg-secondary/50",
              "bg-accent/50",
              "bg-info/50",
              "bg-warning/50",
              "bg-error/50",
            ],
            importantKeys: new Set(),
            allKeys: new Map(),
            // --- PiP ê´€ë ¨ ë³€ìˆ˜ ì¶”ê°€ ---
            pipCount: 0,
            isPipOpen: false,
            pipTarget: null, // Teleport ëª©ì ì§€
            pipWindowRef: null,
            taskSubjects: [
              "1.1.1",
              "1.1.2",
              "1.1.3",
              "1.1.4",
              "1.2.1",
              "1.2.2",
              "1.2.3",
              "1.2.4",
              "1.2.5",
              "1.2.6",
              "1.4.1",
              "1.4.2",
              "1.4.3",
              "1.5.1",
              "1.5.2",
              "2.1.1",
              "2.1.2",
              "3.3.1",
              "3.3.2",
              "3.3.3",
              "4.1.1",
              "4.1.4",
              "4.1.5",
              "4.1.6",
              "4.2.1",
              "4.2.2",
              "4.2.3",
              "4.3.1",
              "4.3.2",
              "4.5.1",
              "4.5.2",
            ],
            selectedSubjects: null,
            inputParams: "",
            paramsComment: "",
            isJustCopied: false,
          };
        },
        methods: {
          jsonInputHandler() {
            try {
              this.allKeys.clear();
              const parsed = JSON.parse(this.inputText);
              this.parsedTree = this.buildTree(parsed, 0);
              console.log(this.parsedTree);
              console.log(this.allKeys);
            } catch (e) {
              this.textAreaEraser();
              this.wrongFormat = true;
              setTimeout(() => {
                this.wrongFormat = false;
              }, 2000);
            }
          },
          applyImportantKeys() {
            try {
              const parsed = JSON.parse(this.inputText);
              this.parsedTree = this.buildTree(parsed, 0, false);
            } catch (e) {
              console.log("error while applying important keys");
            }
          },
          buildTree(obj, depth, doCollect = true) {
            if (typeof obj === "object" && obj !== null) {
              return Object.entries(obj).map(([K, V]) => {
                if (doCollect) {
                  if (!this.allKeys.has(depth))
                    this.allKeys.set(depth, new Set());
                  if (!Array.isArray(obj)) this.allKeys.get(depth).add(K);
                }
                const isChildObject = typeof V === "object" && V !== null;
                const children = isChildObject
                  ? this.buildTree(V, depth + 1, doCollect)
                  : null;
                const hasImportantChild =
                  children && children.some((child) => child.isImportant);
                return {
                  key: K,
                  value: isChildObject ? null : V == null ? "null" : V,
                  hasChild: isChildObject,
                  children: children,
                  isLong: isChildObject || String(V).length > 50,
                  isImportant: this.isImportant(K) || hasImportantChild,
                  depth: depth,
                };
              });
            } else return obj;
          },
          textAreaEraser() {
            this.inputText = "";
            this.parsedTree = null;
            this.allKeys.clear();
            this.inputParams = "";
            this.paramsComment = "";
            this.selectedSubjects = null;
          },
          openSettingsModal() {
            if (this.inputText) this.$refs.settingModal.showModal();
            else {
              this.notYetPasted = true;
              setTimeout(() => {
                this.notYetPasted = false;
              }, 2000);
            }
          },
          toggleKey(key) {
            if (this.importantKeys.has(key)) this.importantKeys.delete(key);
            else this.importantKeys.add(key);
          },
          isImportant(key) {
            return this.importantKeys.has(key);
          },
          // --- PiP ê´€ë ¨ ë©”ì„œë“œ ì¶”ê°€ ---
          async openPipCounter() {
            // 1. ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ í¬ì»¤ìŠ¤ë§Œ í•˜ê³  ì¢…ë£Œ
            if (this.isPipOpen && this.pipWindowRef) {
              this.pipWindowRef.focus();
              return;
            }

            // 2. ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
            if (!window.documentPictureInPicture) {
              alert("PiP ë¯¸ì§€ì› ë¸Œë¼ìš°ì €");
              return;
            }

            try {
              // 3. PiP ì°½ ìƒì„±
              const pipWin =
                await window.documentPictureInPicture.requestWindow({
                  width: 300,
                  height: 250,
                });
              this.pipWindowRef = pipWin;

              // 4. [ë¡œì§ í•µì‹¬] Vue Teleport íƒ€ê²Ÿì„ ìƒˆ ì°½ì˜ bodyë¡œ ì§€ì •
              // ìŠ¤íƒ€ì¼ ë³µì‚¬ ì½”ë“œ ì „ë¶€ ì œê±°í•¨
              this.pipTarget = pipWin.document.body;
              this.isPipOpen = true;

              // 5. ì°½ ë‹«í˜ ê°ì§€ (ìƒíƒœ ì´ˆê¸°í™”)
              pipWin.addEventListener("pagehide", () => {
                this.isPipOpen = false;
                this.pipTarget = null;
                this.pipWindowRef = null;
              });
            } catch (err) {
              console.error("PiP Error:", err);
            }
          },
          refresh() {
            window.location.reload();
          },
          randomSubjects() {
            const selectedSubjectsArray = new Array();
            const subjectsNumber = this.taskSubjects.length;
            const firstRand = Math.floor(Math.random() * subjectsNumber);
            let secondRand = Math.floor(Math.random() * subjectsNumber);
            while (firstRand == secondRand) {
              secondRand = Math.floor(Math.random() * subjectsNumber);
            }
            selectedSubjectsArray.push(this.taskSubjects[firstRand]);
            selectedSubjectsArray.push(this.taskSubjects[secondRand]);
            this.selectedSubjects = selectedSubjectsArray;
          },
          paramsInputHandler() {
            let trimmedInputParams = this.inputParams.trim();
            let parsedParamsJson = "";

            if (!trimmedInputParams.startsWith("{")) {
              trimmedInputParams = `{${trimmedInputParams}}`;
            }

            try {
              parsedParamsJson = JSON.parse(trimmedInputParams);
            } catch (e) {
              this.textAreaEraser();
              this.wrongFormat = true;
              setTimeout(() => {
                this.wrongFormat = false;
              }, 2000);
            }
            const formatter = new Intl.ListFormat("en", {
              style: "long",
              type: "conjunction",
            });
            let comment = "";
            const formattedParsedParamsJson = Object.entries(
              parsedParamsJson
            ).map(([key, value]) => `\`${key}\` "${value}"`);
            this.paramsComment = formatter.format(formattedParsedParamsJson);
          },
          async copyParamsComment() {
            try {
              await navigator.clipboard.writeText(this.paramsComment);
              this.isJustCopied = true;
              setTimeout(() => {
                this.isJustCopied = false;
              }, 2000);
            } catch (err) {
              console.error(err.message);
            }
          },
        },
        computed: {
          isImportantKeysEmpty() {
            return this.importantKeys.size == 0;
          },
        },
      });
      app.component("recur", {
        name: "recur",
        props: ["node", "bgColor", "isImportantKeysEmpty"],
        template: `<details class="w-auto my-1 py-0.5 collapse bg-base-100 border" :class="{'col-span-4': node.isLong}" v-show="isImportantKeysEmpty||node.isImportant" open>
                    <summary class="py-2 collapse-title font-semibold" v-text="node.key" :class="bgColor[node.depth%6]"></summary>
                    <div class="collapse-content text-sm" v-if="!node.hasChild" v-text="node.value"></div>
                    <div v-else :class="{'grid grid-cols-4 gap-x-0.5 auto-rows-max': node.hasChild}">
                      <recur v-for="child in node.children" :node="child" :bg-color="bgColor" :is-important-keys-empty="isImportantKeysEmpty" style="margin-left:10px; margin-right:5px;"></recur>
                    </div>
                  </details>`,
      });
      app.mount("#app");
    </script>
    <!-- /Vue script -->
    <!-- <footer class="footer footer-horizontal">
      <a href="https://www.svgrepo.com" target="_blank">
      Vector icons by SVG Repo</a>
    </footer> -->
  </body>
</html>
